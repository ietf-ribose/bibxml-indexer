openapi: 3.0.1

info:
  title: BibXML indexer
  description: |
    BibXML indexer API. Can be used to trigger dataset index, and check status.
    NOTE: Not all 500 responses are currently provided in the shape of JSON.
  contact:
    email: open.source@ribose.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  version: v1

# TODO: Auto-fill full hostname at deployment time?
servers:
- url: /api/v1

paths:
  /indexer/{dataset}/run:
    get:
      summary: Queues dataset indexing
      description: Creates Celery task that runs indexer for chosen datasets if it
        possible
      operationId: runIndexer
      parameters:
      - name: dataset
        in: path
        description: Dataset ID
        required: true
        schema:
          $ref: '#/components/schemas/IndexableDatasets'
      - name: refs
        in: query
        description: Comma-separated list of refs to index (if not provided, the entire dataset is reindexed)
        schema:
          type: array
          items:
            type: string
        style: form
        explode: false
      responses:
        200:
          description: Indexing task had been queued (does not mean indexing completed without errors)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
        500:
          description: Queueing failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

  /indexer/{dataset}/reset:
    get:
      summary: Clear dataset index
      description: Clears indexed data for given dataset; notably, does not abort any indexing tasks queued or progressing
      operationId: resetIndex
      parameters:
      - name: dataset
        in: path
        description: Dataset ID
        required: true
        schema:
          $ref: '#/components/schemas/IndexableDatasets'
      responses:
        200:
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
        500:
          description: operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

  /indexer/{dataset}/status:
    get:
      summary: Shows latest indexing task status
      description: Returns a list of indexing tasks for given dataset, starting from most recently started task
      operationId: indexerStatus
      parameters:
      - name: dataset
        in: path
        description: Dataset ID
        required: true
        schema:
          $ref: '#/components/schemas/IndexableDatasets'
      responses:
        200:
          description: successful operation, shows index current status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndexerStatus'

  /tasks/{task_id}/stop:
    get:
      summary: Attempts to stop specified task 
      description: Revokes given task, and attempts to terminate if running. Is not guaranteed to take effect immediately
      operationId: stopTask
      parameters:
      - name: task_id
        in: path
        description: Task ID, can be obtained by checking dataset index status
        required: true
        schema:
          $ref: '#/components/schemas/IndexableDatasets'

      responses:
        200:
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
        500:
          description: operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

  /tasks/stop-all:
    get:
      summary: Cancel any pending tasks
      description: Revokes any pending tasks. Notably, is not guaranteed to terminate the already running ones
      operationId: stopAllTasks
      responses:
        200:
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
        500:
          description: operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

components:
  schemas:

    IndexableDatasets:
      type: string
      # TODO: Auto-generate this list at deployment time?
      enum:
      - rfcs
      - ids
      - rfcsubseries
      - misc
      - w3c
      - 3gpp
      - ieee
      - iana
      - doi
      - nist
      description: |
        For up-to-date list of available datasets,
        see bibxml-data-* repositories under ietf-ribose GitHub organization.
        See also bibxml-indexer service README.

    SuccessMessage:
      type: object
      description: Success response
      properties:
        message:
          type: string
          description: Human-readable success message

    ErrorMessage:
      type: object
      description: Error response
      properties:
        error:
          type: object
          properties:
            code:
              type: integer
              description: Code for automatic error processing
            message:
              type: string
              description: Human-readable error message

    IndexerStatus:
      type: object
      description: Recent dataset indexing task history
      properties:
        tasks:
          description: A list of most recent indexing tasks for given dataset
          type: array
          items:
            type: object
            description: Describes indexing task
            required:
              - task_id
            properties:
              task_id:
                format: string
                description: Task ID; can be used to cancel this task using the tasks endpoint
              requested_refs:
                type: array
                description: Refs that were requested for indexing
                items:
                  type: string
              status:
                type: string
                description: Short status keyword (e.g., STARTED, PROGRESS, FAILED or similar; not strictly normalized)

              started_at:
                type: string
                format: datetime

              action:
                type: string
                description: For a task in progress, human-readable summary of whatâ€™s currently happening
              progress:
                description: For a task in progress, completion progress
                type: object
                required:
                  - indexed
                properties:
                  total:
                    description: Total number of source files found
                    type: integer
                  indexed:
                    description: Total number of indexed files
                    type: integer

              completed_at:
                type: string
                format: datetime
                description: For a successful task, completion timestamp
              outcome_summary:
                type: string
                description: For a successful task, human-readable description of the outcome

              error:
                type: object
                description: For a failed task, error details
                properties:
                  type:
                    type: string
                  message:
                    type: string
